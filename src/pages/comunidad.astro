---
import BaseLayout from '../layouts/BaseLayout.astro';
import EventButton from '../components/EventButton.preact';

// Datos mock para las discusiones (ampliado para paginaci√≥n)
const discussions = [
  {
    id: 1,
    title: "¬øQu√© manga me recomend√°is despu√©s de terminar Attack on Titan?",
    author: "Kaito_92",
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Kaito",
    replies: 23,
    views: 156,
    category: "Recomendaciones",
    lastActivity: "Hace 2 horas",
    isHot: true
  },
  {
    id: 2,
    title: "Debate: ¬øOne Piece superar√° a Dragon Ball como el shonen definitivo?",
    author: "MangaLover21",
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=MangaLover",
    replies: 87,
    views: 542,
    category: "Debate",
    lastActivity: "Hace 15 min",
    isHot: true
  },
  {
    id: 3,
    title: "Colecci√≥n de ediciones especiales - ¬øCu√°l es vuestra favorita?",
    author: "CollectorPro",
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Collector",
    replies: 34,
    views: 289,
    category: "Coleccionismo",
    lastActivity: "Hace 1 d√≠a",
    isHot: false
  },
  {
    id: 4,
    title: "Rese√±a: Chainsaw Man Vol. 12 - Sin spoilers",
    author: "YukiReviews",
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Yuki",
    replies: 12,
    views: 98,
    category: "Rese√±as",
    lastActivity: "Hace 3 horas",
    isHot: false
  },
  {
    id: 5,
    title: "¬øAlguien m√°s est√° leyendo Vagabond? Obra maestra total",
    author: "SamuraiReader",
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Samurai",
    replies: 45,
    views: 312,
    category: "Seinen",
    lastActivity: "Hace 5 horas",
    isHot: false
  },
  {
    id: 6,
    title: "Mis predicciones para el final de Jujutsu Kaisen",
    author: "CursedUser",
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Cursed",
    replies: 67,
    views: 421,
    category: "Teor√≠as",
    lastActivity: "Hace 30 min",
    isHot: true
  },
  {
    id: 7,
    title: "Gu√≠a para principiantes: C√≥mo empezar a coleccionar manga",
    author: "MangaSensei",
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Sensei",
    replies: 28,
    views: 187,
    category: "Gu√≠as",
    lastActivity: "Hace 2 d√≠as",
    isHot: false
  },
  {
    id: 8,
    title: "¬øQu√© opinan de los manhwa coreanos? Recomendaciones",
    author: "AsianComics",
    avatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Asian",
    replies: 52,
    views: 298,
    category: "Manhwa",
    lastActivity: "Hace 6 horas",
    isHot: false
  }
];

// Rese√±as destacadas
const reviews = [
  {
    manga: "Spy x Family Vol. 10",
    author: "Ana M.",
    rating: 5,
    comment: "Cada vez me sorprende m√°s. La combinaci√≥n de comedia, acci√≥n y momentos emotivos est√° perfectamente equilibrada. Anya sigue siendo lo mejor.",
    date: "15 Dic 2025"
  },
  {
    manga: "Jujutsu Kaisen Vol. 22",
    author: "Carlos R.",
    rating: 5,
    comment: "Brutal. Este volumen lleva la intensidad al m√°ximo. Los combates est√°n incre√≠blemente bien dibujados. Totalmente recomendado.",
    date: "14 Dic 2025"
  },
  {
    manga: "Blue Lock Vol. 15",
    author: "Marta S.",
    rating: 4,
    comment: "El ritmo sigue siendo fren√©tico. Aunque a veces se siente repetitivo, la tensi√≥n en cada partido te mantiene enganchado.",
    date: "13 Dic 2025"
  }
];

// Eventos pr√≥ximos
const events = [
  {
    title: "Club de Lectura Online: Berserk",
    date: "22 Diciembre 2025",
    time: "19:00 - 21:00",
    type: "online",
    participants: 45,
    maxParticipants: 50
  },
  {
    title: "Torneo de Trivial Manga",
    date: "28 Diciembre 2025",
    time: "18:00 - 20:00",
    type: "presencial",
    participants: 12,
    maxParticipants: 20
  },
  {
    title: "Sorteo Mensual - Edici√≥n Deluxe",
    date: "31 Diciembre 2025",
    time: "20:00",
    type: "online",
    participants: 234,
    maxParticipants: null
  }
];

// Recomendaciones de la comunidad con IDs de Jikan API
const recommendations = [
  {
    manga: "Frieren: Beyond Journey's End",
    malId: 126287,
    votes: 342,
    tag: "Fantas√≠a"
  },
  {
    manga: "Dandadan",
    malId: 135496,
    votes: 298,
    tag: "Acci√≥n"
  },
  {
    manga: "Sakamoto Days",
    malId: 131334,
    votes: 267,
    tag: "Comedia"
  }
];

// Obtener im√°genes de la API de Jikan
const recommendationsWithImages = await Promise.all(
  recommendations.map(async (rec) => {
    try {
      const response = await fetch(`https://api.jikan.moe/v4/manga/${rec.malId}`);
      const data = await response.json();
      return {
        ...rec,
        cover: data.data.images.jpg.large_image_url || data.data.images.jpg.image_url
      };
    } catch (error) {
      console.error(`Error fetching ${rec.manga}:`, error);
      return {
        ...rec,
        cover: "https://images.unsplash.com/photo-1618519764620-7403abdbdfe9?w=400&h=600&fit=crop"
      };
    }
  })
);
---

<BaseLayout 
  title="Comunidad - Akihabara Manga Store"
  description="√önete a nuestra comunidad de lectores de manga. Comparte, debate y descubre nuevas series."
  activeNav="comunidad"
>
  <!-- Header -->
  <section class="py-12 bg-gradient-to-br from-primary-500 to-secondary-600">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl mx-auto text-center">
        <h1 class="font-display text-4xl md:text-5xl text-white mb-4">
          Comunidad
        </h1>
        <p class="text-xl text-primary-50 mb-6">
          M√°s de 50,000 lectores compartiendo su pasi√≥n por el manga
        </p>
        <div class="flex flex-wrap gap-4 justify-center">
          <a href="#foro" class="btn-secondary bg-white/20 hover:bg-white/30 text-white border-white/30">
            üí¨ Ver Foro
          </a>
          <a href="#eventos" class="btn-secondary bg-white/20 hover:bg-white/30 text-white border-white/30">
            üìÖ Pr√≥ximos Eventos
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats -->
  <section class="py-12 bg-white border-b border-dark-100">
    <div class="container mx-auto px-4">
      <div class="max-w-5xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="text-center">
          <div class="text-3xl md:text-4xl font-bold text-primary-600 mb-2">50K+</div>
          <div class="text-dark-600 text-sm">Miembros</div>
        </div>
        <div class="text-center">
          <div class="text-3xl md:text-4xl font-bold text-secondary-600 mb-2">1.2K</div>
          <div class="text-dark-600 text-sm">Discusiones</div>
        </div>
        <div class="text-center">
          <div class="text-3xl md:text-4xl font-bold text-primary-600 mb-2">8.5K</div>
          <div class="text-dark-600 text-sm">Rese√±as</div>
        </div>
        <div class="text-center">
          <div class="text-3xl md:text-4xl font-bold text-secondary-600 mb-2">24/7</div>
          <div class="text-dark-600 text-sm">Activo</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Foro / Discusiones -->
  <section id="foro" class="py-16 bg-dark-50">
    <div class="container mx-auto px-4">
      <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between mb-8">
          <h2 class="font-display text-3xl text-dark-900">
            Discusiones Activas
          </h2>
          <button class="btn-primary text-sm">
            + Nueva Discusi√≥n
          </button>
        </div>

        <!-- Discusiones -->
        <div id="discussions-container" class="space-y-4">
          {discussions.map(discussion => (
            <div class="discussion-item bg-white rounded-xl shadow-md hover:shadow-xl transition-shadow border border-dark-100 p-6" data-discussion-id={discussion.id}>
              <div class="flex items-start gap-4">
                <img 
                  src={discussion.avatar} 
                  alt={discussion.author}
                  class="w-12 h-12 rounded-full flex-shrink-0"
                />
                
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-2">
                    {discussion.isHot && (
                      <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded">
                        üî• HOT
                      </span>
                    )}
                    <span class="px-2 py-1 bg-primary-100 text-primary-700 text-xs font-semibold rounded">
                      {discussion.category}
                    </span>
                  </div>
                  
                  <h3 class="text-lg font-semibold text-dark-900 mb-2 hover:text-primary-600 cursor-pointer">
                    {discussion.title}
                  </h3>
                  
                  <div class="flex flex-wrap items-center gap-4 text-sm text-dark-600">
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                      {discussion.author}
                    </span>
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                      </svg>
                      {discussion.replies}
                    </span>
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      {discussion.views}
                    </span>
                    <span class="ml-auto text-primary-600">
                      {discussion.lastActivity}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>

        <!-- Paginaci√≥n -->
        <div class="mt-8 flex flex-col sm:flex-row items-center justify-between gap-4">
          <div id="pagination-info" class="text-sm text-dark-600"></div>

          <div class="flex items-center gap-2">
            <button
              id="prev-page"
              class="px-4 py-2 border border-dark-300 rounded-lg text-sm font-medium text-dark-700 hover:bg-dark-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              ‚Üê Anterior
            </button>

            <div id="page-numbers" class="flex items-center gap-1"></div>

            <button
              id="next-page"
              class="px-4 py-2 border border-dark-300 rounded-lg text-sm font-medium text-dark-700 hover:bg-dark-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Siguiente ‚Üí
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Rese√±as Recientes -->
  <section class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <div class="max-w-6xl mx-auto">
        <h2 class="font-display text-3xl text-dark-900 mb-8">
          Rese√±as Recientes
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {reviews.map(review => (
            <div class="bg-gradient-to-br from-primary-50 to-white rounded-xl shadow-lg border border-primary-200 p-6 hover:shadow-xl transition-shadow">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-display text-lg text-dark-900 font-semibold">
                  {review.manga}
                </h3>
                <div class="flex gap-0.5">
                  {Array.from({ length: review.rating }).map((_, i) => (
                    <svg key={i} class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                  ))}
                </div>
              </div>

              <p class="text-dark-700 text-sm mb-4 leading-relaxed">
                "{review.comment}"
              </p>

              <div class="flex items-center justify-between text-xs text-dark-600">
                <span class="font-semibold">{review.author}</span>
                <span>{review.date}</span>
              </div>
            </div>
          ))}
        </div>

        <div class="mt-8 text-center">
          <button class="btn-secondary">
            Ver Todas las Rese√±as ‚Üí
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Recomendaciones de la Comunidad -->
  <section class="py-16 bg-dark-50">
    <div class="container mx-auto px-4">
      <div class="max-w-6xl mx-auto">
        <h2 class="font-display text-3xl text-dark-900 mb-4">
          Top Recomendaciones del Mes
        </h2>
        <p class="text-dark-600 mb-8">
          Lo m√°s votado por nuestra comunidad este mes
        </p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {recommendationsWithImages.map((rec, index) => (
            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow border border-dark-100">
              <!-- Imagen -->
              <div class="relative h-48 overflow-hidden">
                <img 
                  src={rec.cover} 
                  alt={rec.manga}
                  class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                />
                <div class="absolute top-3 left-3">
                  <span class="px-2.5 py-1 bg-white/95 backdrop-blur text-dark-900 text-xs font-bold rounded-full">
                    #{index + 1}
                  </span>
                </div>
              </div>
              
              <!-- Contenido -->
              <div class="py-3 px-4">
                <!-- Tag de g√©nero -->
                <span class="inline-block px-2.5 py-1 bg-primary-500 text-white text-xs font-semibold rounded-full mb-2">
                  {rec.tag}
                </span>
                
                <!-- T√≠tulo y bot√≥n de like en la misma l√≠nea -->
                <div class="flex items-start justify-between gap-3">
                  <h3 class="font-display text-base text-dark-900 font-semibold leading-tight flex-1">
                    {rec.manga}
                  </h3>
                  
                  <div class="flex items-center gap-2 flex-shrink-0">
                    <button 
                      class="like-button transition-all hover:scale-110"
                      data-votes={rec.votes}
                      data-liked="false"
                    >
                      <svg class="w-5 h-5 text-dark-400 hover:text-primary-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 20 20">
                        <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z" />
                      </svg>
                    </button>
                    <span class="text-sm text-dark-600 font-semibold votes-count whitespace-nowrap">{rec.votes}</span>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Eventos Pr√≥ximos -->
  <section id="eventos" class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <div class="max-w-6xl mx-auto">
        <h2 class="font-display text-3xl text-dark-900 mb-8">
          Pr√≥ximos Eventos
        </h2>

        <div class="space-y-4">
          {events.map(event => (
            <div class="bg-gradient-to-r from-secondary-50 to-white rounded-xl shadow-lg border border-secondary-200 p-6 hover:shadow-xl transition-shadow">
              <div class="flex flex-col md:flex-row md:items-center gap-4">
                <!-- Fecha -->
                <div class="flex-shrink-0 bg-gradient-to-br from-secondary-500 to-secondary-600 text-white rounded-xl p-4 text-center w-24">
                  <div class="text-2xl font-bold">
                    {new Date(event.date).getDate()}
                  </div>
                  <div class="text-sm uppercase">
                    {new Date(event.date).toLocaleDateString('es', { month: 'short' })}
                  </div>
                </div>

                <!-- Info -->
                <div class="flex-1">
                  <div class="flex items-center gap-2 mb-2">
                    <span class={`px-3 py-1 rounded-full text-xs font-semibold ${
                      event.type === 'online' 
                        ? 'bg-blue-100 text-blue-700' 
                        : 'bg-green-100 text-green-700'
                    }`}>
                      {event.type === 'online' ? 'üåê Online' : 'üìç Presencial'}
                    </span>
                  </div>
                  
                  <h3 class="font-display text-xl text-dark-900 mb-1">
                    {event.title}
                  </h3>
                  
                  <div class="flex items-center gap-4 text-sm text-dark-600">
                    <span class="flex items-center gap-1">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      {event.time}
                    </span>
                  </div>
                </div>

                <!-- Bot√≥n con contador -->
                <div class="flex-shrink-0">
                  <EventButton 
                    initialParticipants={event.participants} 
                    maxParticipants={event.maxParticipants}
                    client:load 
                  />
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Final -->
  <section class="py-16 bg-gradient-to-br from-primary-500 to-secondary-600">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl mx-auto text-center">
        <h2 class="font-display text-3xl md:text-4xl text-white mb-4">
          ¬øListo para unirte?
        </h2>
        <p class="text-xl text-primary-50 mb-8">
          Crea tu cuenta gratis y empieza a participar en la comunidad m√°s activa de manga en espa√±ol
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <button class="btn-primary bg-white text-primary-600 hover:bg-primary-50">
            Crear Cuenta Gratis
          </button>
          <button class="btn-secondary bg-white/20 hover:bg-white/30 text-white border-white/30">
            Ya tengo cuenta
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Script de paginaci√≥n -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      const itemsPerPage = 3;
      let currentPage = 1;
      
      const discussionItems = document.querySelectorAll('.discussion-item');
      const totalItems = discussionItems.length;
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      
      const paginationInfo = document.getElementById('pagination-info');
      const pageNumbersContainer = document.getElementById('page-numbers');
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');

      function showPage(page) {
        currentPage = page;
        
        // Ocultar todos los items
        discussionItems.forEach((item, index) => {
          item.style.display = 'none';
        });
        
        // Mostrar items de la p√°gina actual
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        
        for (let i = start; i < end && i < totalItems; i++) {
          discussionItems[i].style.display = 'block';
        }
        
        // Actualizar info
        const startNum = start + 1;
        const endNum = Math.min(end, totalItems);
        paginationInfo.textContent = `Mostrando ${startNum} - ${endNum} de ${totalItems} discusiones`;
        
        // Actualizar botones
        prevBtn.disabled = page === 1;
        nextBtn.disabled = page === totalPages;
        
        // Actualizar n√∫meros de p√°gina
        renderPageNumbers();
        
        // Scroll suave
        document.getElementById('foro').scrollIntoView({ behavior: 'smooth' });
      }

      function renderPageNumbers() {
        pageNumbersContainer.innerHTML = '';
        
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          btn.className = `w-10 h-10 rounded-lg text-sm font-semibold transition-colors ${
            currentPage === i
              ? 'bg-primary-600 text-white'
              : 'text-dark-700 hover:bg-dark-100'
          }`;
          btn.addEventListener('click', () => showPage(i));
          pageNumbersContainer.appendChild(btn);
        }
      }

      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) showPage(currentPage - 1);
      });

      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) showPage(currentPage + 1);
      });

      // Mostrar primera p√°gina
      showPage(1);
    });
  </script>

  <!-- Script para manejar likes -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      const likeButtons = document.querySelectorAll('.like-button');
      
      likeButtons.forEach(button => {
        button.addEventListener('click', function() {
          const isLiked = this.getAttribute('data-liked') === 'true';
          const votesElement = this.parentElement.querySelector('.votes-count');
          let currentVotes = parseInt(this.getAttribute('data-votes'));
          const icon = this.querySelector('svg');
          
          if (isLiked) {
            // Quitar like
            currentVotes -= 1;
            this.setAttribute('data-liked', 'false');
            icon.setAttribute('fill', 'none');
            icon.classList.remove('text-primary-600');
            icon.classList.add('text-dark-400');
          } else {
            // Dar like
            currentVotes += 1;
            this.setAttribute('data-liked', 'true');
            icon.setAttribute('fill', 'currentColor');
            icon.classList.remove('text-dark-400');
            icon.classList.add('text-primary-600');
          }
          
          this.setAttribute('data-votes', currentVotes);
          votesElement.textContent = currentVotes;
        });
      });
    });
  </script>
</BaseLayout>
